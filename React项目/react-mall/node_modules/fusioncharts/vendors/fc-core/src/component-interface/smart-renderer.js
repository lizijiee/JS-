import ComponentBase,{addAllEventsOnGraphic,removeAllEventsFromGraphic}from'./component-base';let UNDEF,addEventOnAllGraphics=function(a,b,c){var d;b&&c&&(d=a=>{!a._skipEvents&&a.on&&a.on(b,c)},_mapSubFnForward(a.getGraphicalElement(),d))},removeEventFromAllGraphics=function(a,b,c){var d;b&&c&&(d=a=>{!a._skipEvents&&a.off&&a.off(b,c)},_mapSubFnForward(a.getGraphicalElement(),d))},_mapSubFnBackward=(a,b)=>{if(a&&a.hasOwnProperty&&b&&b.call){let c,d,e,f;for(d in a)for(c=a[d],e=c.elemStore,f=e&&e.length-1;0<=f&&!b(e[f],d,f);f--);}},_mapSubFnForward=(a,b)=>{if(a&&a.hasOwnProperty&&b&&b.call){let c,d,e,f,g;for(e in a)for(c=a[e],f=c.elemStore,(g=0,d=f&&f.length);g<d&&!b(f[g],e,g);g++);}};class SmartRenderer extends ComponentBase{constructor(a){super();let b=this;b._id=a,b._componentStore={},b._oldComponentStore=[],b.fireEvent('instantiated'),b.__setDefaultConfig()}syncDraw(){this._removeUnusedComponent(),this._resetGraphicalStore(),super.syncDraw(),this._removeUnusedGraphics()}setDimension(a,b){this.config.width=a,this.config.height=b}setTranslation(a,b){var c=this,d=c.config;d._translateX=a,d._translateY=b,d.translate=`t${a},${b}`}getTranslation(){return{x:this.config._translateX,y:this.config._translateY}}_resetGraphicalStore(){let a=this;a._oldGraphicalStore=a._graphicalStore,a._graphicalStore={}}_getLastUsedElem(){return this.config.lastElemUsed}addGraphicalElement(a={},b){let c,d,e,f,g=this,h=g.getFromEnv('animationManager'),i=a.label,j=g._graphicalStore[i]||(g._graphicalStore[i]={elemStore:[],idMap:{},indexMap:{},lastIndexUsed:-1}),k=!0,l=g._oldGraphicalStore&&g._oldGraphicalStore[i],m=j.lastIndexUsed+=1,n=a.id;l&&(n&&l.idMap[n]!==void 0?(e=l.idMap[n],f=l.elemStore[e],delete l.elemStore[e],delete l.indexMap[e],delete l.idMap[n]):l.elemStore[m]&&!l.indexMap[m]&&(f=l.elemStore[m],delete l.elemStore[m])),f&&(a.el=f,k=!1),(d=a.container)?(c=d.isParent?g.getLinkedParent():g,a.container=c.getGraphicalElement(d.id,d.label)||c.getChildContainer(d.id)):a.container=g.getFromEnv('chart-container'),f=h.setAnimation(a),j.elemStore[m]=f,n&&(j.idMap[n]&&(delete j.indexMap[j.idMap[n]],delete j.idMap[n]),j.idMap[n]=m,j.indexMap[m]=n),g.fireEvent('graphicalelementattached',{element:f}),f._skipEvents=b,a.shadow&&f.shadow(a.shadow),a.tooltext&&g.getFromEnv('toolTipController').enableToolTip(f,a.tooltext),g.config.lastElemUsed=f,!b&&k&&addAllEventsOnGraphic(f,g._middleListeners,g)}removeGraphicalElement(a,b){var c,d,e,f,g=this,h=g._graphicalStore;'object'==typeof a?_mapSubFnBackward(h,(b,d,e)=>{if(a===b)return f=!0,b._skipEvents||removeAllEventsFromGraphic(b,g._middleListeners),g._setRemoveAnim(b,d),c=h[d],c.elemStore.splice(e,1),delete c.idMap[c.indexMap[e]],delete c.indexMap[e],!0}):_mapSubFnBackward(h,(d,j,k)=>{if(c=h[j],e=c.indexMap,e[k]===a&&(!b||b===j))return f=!0,d._skipEvents||removeAllEventsFromGraphic(d,g._middleListeners),g._setRemoveAnim(d,j),c.elemStore.splice(k,1),delete c.idMap[c.indexMap[k]],delete c.indexMap[k],!0}),f&&this.fireEvent('graphicalelementremoved',{element:d})}getChildContainer(a){return this.getGraphicalElement(UNDEF,a)}_removeUnusedGraphics(){let a,b=this,c=b._oldGraphicalStore;_mapSubFnBackward(c,(d,e,f)=>{d&&(!d._skipEvents&&removeAllEventsFromGraphic(d,b._middleListeners),b._setRemoveAnim(d,e),a=c[e],delete a.idMap[a.indexMap[f]],delete a.indexMap[f])})}getGraphicalElement(a,b){let c,d,e,f,g,h=this,j=h._graphicalStore;return b||a?b?(c=j[b],a?c&&c.elemStore&&c.elemStore[c.idMap[a]]:c&&c.elemStore&&c.elemStore[0]):(_mapSubFnForward(j,function(){if(g=arguments[2],e=j[arguments[1]],d=e.idMap,d[g]===a)return f=e.elemStore[g],!0}),f):j}addEventListener(a,b,c){var d=super.addEventListener(a,b,c);return!0===d?(addEventOnAllGraphics(this,a,this._middleListeners[a]),b):!!d&&b}removeEventListener(a,b){super.removeEventListener(a,b)&&removeEventFromAllGraphics(this,a,this._middleListeners[a])}_dispose(){let a,b=this;if(super._dispose()){for(a in b.getFromEnv('paper')&&!b.getFromEnv('paper').removed&&_mapSubFnForward(b.getGraphicalElement(),b.__instantRemoveFn),b)b.hasOwnProperty(a)&&delete b[a];b.fireEvent('removed')}}removingDraw(){var a=this;_mapSubFnForward(a.getGraphicalElement(),a._setRemoveAnim)}configure(a){this._resetComponentStore(),super.configure(a)}_resetComponentStore(){let a=this;a._oldComponentStore.push(a._componentStore),a._componentStore={}}_mapChildren(a,b){b?_mapSubFnBackward(this.getChildren(),a):_mapSubFnForward(this.getChildren(),a)}attachChild(a,b,c){let d,e,f=this,g=f._componentStore[b]||(f._componentStore[b]={elemStore:[],idMap:{},indexMap:{},lastIndexUsed:-1}),h=f._oldComponentStore&&f._oldComponentStore.length&&f._oldComponentStore[f._oldComponentStore.length-1][b],i=g.lastIndexUsed+=1;return h&&(c&&void 0!==h.idMap[c]?(d=h.idMap[c],e=h.elemStore[d],delete h.elemStore[d],delete h.indexMap[d],delete h.idMap[c]):h.elemStore[i]&&!h.indexMap[i]&&(e=h.elemStore[i],delete h.elemStore[i])),e||(e=new a(c)),g.elemStore[i]=e,c&&(g.idMap[c]=i,g.indexMap[i]=c),e._setLinkedParent(f),f.fireEvent('childattached',{attachedChild:e}),e}_removeUnusedComponent(){let a=this,b=a._oldComponentStore,c=b.length,d=0,e=(a,c,e)=>{let f;a&&(f=b[d][c],delete f.idMap[f.indexMap[e]],delete f.indexMap[e],a.remove())};for(;d<c;d+=1)_mapSubFnBackward(b[d],e);a._oldComponentStore.length=0}getChild(a,b){var c,d=this._componentStore;return this._searchChildren(a,function(a){c=a},b),c||d}_searchChildren(a,b,c){var d,e,f,g,h=this,j=h._componentStore;if(a?_mapSubFnBackward(j,(b,h,k)=>{if(d=j[h],f=d.indexMap,f[k]===a&&(!c||c===h))return g=b,e=k,c=h,!0}):g=j[c]&&j[c].elemStore,g)return b(g,e,c)}getChildren(a){return a?this._componentStore[a]&&this._componentStore[a].elemStore:this._componentStore}detachChild(a){var b,c,d=this,e=d._componentStore;return a===UNDEF?UNDEF:(d._searchChildren(a,function(a,f,g){c=e[g],c.elemStore.splice(f,1),delete c.idMap[c.indexMap[f]],delete c.indexMap[f],a._setLinkedParent(UNDEF),b=a,d.fireEvent('childdetached',{detachedChild:b})}),b)}}export default SmartRenderer;