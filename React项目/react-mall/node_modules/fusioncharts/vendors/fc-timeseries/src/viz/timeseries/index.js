import chain from'ramda/es/chain';import addIndex from'ramda/es/addIndex';import xprod from'ramda/es/xprod';import clone from'ramda/es/clone';import unique from'ramda/es/uniq';import zipObj from'ramda/es/zipObj';import CommonAPI from'../../../../fc-charts/src/chart/_internal/commonchartapi';import{pluckNumber,pluck,safeMax,extend2,convertColor,getLinkAction,hashify,HASHSTRING,toRaphaelColor,getLightColor,regex,extent,UNDEF}from'../../../../fc-core/src/lib';import ColorManager from'../../../../fc-charts/src/_internal/color-utils/colormanager';import Line from'../../_internal/components/dataset/line';import timeNavigatorFactory from'./factories/navigator-time';import toolbarFactory from'../../../src/_internal/factories/toolbar-factory';import standardRangeSelectorFactory from'../../../src/_internal/factories/standard-range-selector.factory';import legendFactory from'../../../src/_internal/factories/legend-factory';import xFactory from'./factories/x';import yFactory from'./factories/y';import CaptionFactory from'./factories/caption';import CustomRangeFactory from'./factories/custom-range-selector';import CrosslineManager from'../../_internal/factories/multicanvas-crossline-manager';import panelFactory from'./factories/panel';import expanderAxis from'./_utils/expanders/axis';import expanderPanel from'./_utils/expanders/panel';import expanderSeries from'./_utils/expanders/series';import OrdinalScale from'../../../../fc-core/src/axis/scales/ordinal';import arrayHasContent from'../../../../fc-utils/src/type/array-has-content';import stringHasContent from'../../../../fc-utils/src/type/string-has-content';import jss from'jss';import preset from'jss-preset-default';import backgroundFactory from'./factories/background';import{groupBy,between,pivot}from'../../../../fc-datatable/src/operators';import{DatetimeUnits as time}from'../../../../fc-utils/src/datetime-enums';import isValidNumber from'../../../../fc-utils/src/type/is-valid-number';import{timeYear}from'../../../../fc-utils/src/time-intervals';class NodeTable{constructor(a){this._table=a}getTable(){return this._table}getData(){return this._data||(this._data=this._table.getData()),this._data}}jss.setup(preset()),jss.createStyleSheet({"@font-face":{"font-family":'Source Sans Pro',"font-style":'normal',"font-weight":'400',src:'local(\'Source Sans Pro Regular\'), local(\'SourceSansPro-Regular\'), url(https://fonts.gstatic.com/s/sourcesanspro/v11/6xK3dSBYKcSV-LCoeQqfX1RYOo3qOK7j.woff) format(\'woff\');',"unicode-range":' U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;'}}).attach();const DEFAULT_CANVAS_DISTANCE=20,DEFAULT_TIMENAV_HEIGHT_RATIO=.25,DEFAULT_AXIS_HEIGHT_RATIO=.6,DEFAULT_CAPTION_HEIGHT_RATIO=.3,DEFAULT_LEGEND_RATIO=.1,CANVAS_TOP_PADDING=6,LINE_HEIGHT_FACTOR=1.2,dropHash=regex.dropHash,capsFirst=a=>a.charAt(0).toUpperCase()+a.slice(1),permuteIndices=a=>a.map(a=>({x:a.x,y:a.y,plots:xprod(a.x.map(a=>a.index),a.y.map(a=>a.index)).map(a=>({x:a[0],y:a[1]}))})),getIndex=a=>+a.split('_').pop(),toolbarPositionParser=function(a){return a='tr'===a||'rt'===a||'top right'===a||'right top'===a?'tr':'br'===a||'rb'===a||'bottom right'===a||'right bottom'===a?'br':'tl'===a||'lt'===a||'top left'===a||'left top'===a?'tl':'bl'===a||'lb'===a||'bottom left'===a||'left bottom'===a?'bl':'tr',a},isTemporalScheme=a=>'date'===a.type||'interval'===a.type,isNumericScheme=a=>'number'===a.type,isStringyScheme=a=>'string'===a.type,flatMap=addIndex(chain),defaultPanels=(a,b)=>flatMap((a,c)=>b.map((a,b,d)=>({x:[{index:c,visible:b===d.length-1}],y:[{index:b}]})),a),parsePaletteColor=(a=[])=>{let b=[];return arrayHasContent(a)?b=a.slice():stringHasContent(a)&&(b=a.split(/\s*,\s*/)),b=b.filter(a=>!!a),b.map(a=>hashify(a))},setLineHeight=(a,b)=>{'object'==typeof a&&(a['line-height']||(a['line-height']=(parseFloat(a['font-size'])||b||10)*LINE_HEIGHT_FACTOR))},filterer=(a,b)=>{for(let c in a)a[c]._fc_info.table=new NodeTable(a[c]._fc_info.filter?b.table.getTable().query([a[c]._fc_info.filterInfo.query]):b.table.getTable()),a[c]._fc_info.filterInfo.table=a[c]._fc_info.table,tableCreator(a[c])},pivoter=(a,b)=>{for(let c in a)a[c]._fc_info.table=b.table,tableCreator(a[c])},aggregator=a=>{let b=a.op,c=a.operands;return Object.keys(c).map(a=>({column:a,operation:b}))},binner=(a,b)=>{for(let c in a){let d=a[c]._fc_info.scale,e=a[c]._fc_info.chart,f=d.getRangeThreshold(),g=[{column:a[c]._fc_info.bin,timeUnit:time[capsFirst(f[0].name())],binSize:f[1],startValue:a[c]._fc_info.totalStart}],h=b.pivot,i=b.table.getTable();for(let b in a[c])if('aggregate'===b){let j,k,l=a[c][b]._fc_info,m=[],n=[],o=[],p=[];for(let a in l)m.push({op:a,operands:l[a]});n=chain(aggregator,m),h?(j=pivot(g,h,n),o=i.unique(h)):j=groupBy(g,n),e.addEventListener('focusLimitChanged',()=>{f=d.getRangeThreshold(),g=[{column:a[c]._fc_info.bin,timeUnit:time[capsFirst(f[0].name())],binSize:f[1],startValue:a[c]._fc_info.totalStart}],h?j._updateArgs(g,h,n):j._updateArgs(g,n)}),k=new NodeTable(i.query([j])),m.forEach(b=>{for(let d in b.operands.table=k,b.operands.position=a[c]._fc_info.bin,b.operands)if('plottype'!==d){const a=a=>a.column===d&&a.operation===b.op;p=0<o.length?chain(b=>n.filter(a).map(a=>[b,a.column,a.operation]),o).map(a=>a.join(' - ')):n.filter(a).map(a=>[a.column,a.operation].join(' - ')),p.forEach(a=>b.operands[d].push(a))}})}}},tableCreator=a=>{for(let b in a){const c=a[b];'filter'==b?filterer(c,a._fc_info):'pivot'==b?pivoter(c,a._fc_info):'bin'==b&&binner(c,a._fc_info)}},mapper=(a,b)=>{let c,d,e,f,g,h;b?(c=a.config.contextPanels,d=a.config.contextAxesX,e=a.config.contextAxesY,f=a.getFromEnv('contextScalesX'),g=a.getFromEnv('contextScalesY'),h=a.config.contextTableMap):(c=a.config.focusPanels,d=a.config.focusAxesX,e=a.config.focusAxesY,f=a.getFromEnv('focusScalesX'),g=a.getFromEnv('focusScalesY'),h=a.config.focusTableMap);for(let j=0,i=c.length;j<i;j++){const b=c[j].plots;for(let c=0,i=b.length;c<i;c++){const i=b[c],j=d[i.x],k=e[i.y],l=f[i.x],m=l.getRangeThreshold(),n=l.getBinDomain().map(Number),o=g[i.y];let p=h;i.plots||(i.plots=[]),j.scale=l,k.scale=o,j.filter&&(!p.filter&&(p.filter={}),p=p.filter,j.filterInfo.query=between(j.filter[0],n[0]-2*m[2],n[1]+2*m[2]),!p[`x__FC_OP_SEP__${i.x}`]&&(p[`x__FC_OP_SEP__${i.x}`]={_fc_info:{filter:j.filter[0],filterInfo:j.filterInfo,start:n[0],end:n[1]}}),p=p[`x__FC_OP_SEP__${i.x}`]),k.filter&&(!p&&(p.filter={}),p=p.filter,!p[`y__FC_OP_SEP__${i.y}`]&&(p[`y__FC_OP_SEP__${i.y}`]={_fc_info:{filter:k.filter[0]}}),p=p[`y__FC_OP_SEP__${i.y}`]),j.pivot&&(!p.pivot&&(p.pivot={}),p=p.pivot,!p[j.pivot[0]]&&(p[j.pivot[0]]={_fc_info:{pivot:j.pivot[0]}}),p=p[j.pivot[0]]),k.pivot&&(!p.pivot&&(p.pivot={}),p=p.pivot,!p[k.pivot[0]]&&(p[k.pivot[0]]={_fc_info:{pivot:k.pivot[0]}}),p=p[k.pivot[0]]),j.bin&&(!p.bin&&(p.bin={}),p=p.bin,!p[`x__FC_OP_SEP__${i.x}`]&&(p[`x__FC_OP_SEP__${i.x}`]={_fc_info:{chart:a,bin:j.bin[0],scale:l,totalStart:+timeYear.floor(new Date(a.config.dataTable.min(j.bin[0])))}}),p=p[`x__FC_OP_SEP__${i.x}`]),k.bin&&(!p.bin&&(p.bin={}),p=p.bin,!p[`y__FC_OP_SEP__${i.y}`]&&(p[`y__FC_OP_SEP__${i.y}`]={_fc_info:{bin:k.bin[0]}}),p=p[`y__FC_OP_SEP__${i.y}`]),j.aggregate&&(!p.aggregate&&(p.aggregate={}),p=p.aggregate,j.aggregate.forEach((b,a)=>{const c=b.aggregation||'avg',d=b.columnname;p[c]||(p[c]={_fc_info:{}}),i.plot||(i.plot={plottype:j.columnname[a].plottype}),i.plot.value=p[c]._fc_info[d]={}})),k.plot.forEach(a=>{if(p.aggregate||(p.aggregate={_fc_info:{}}),'candlestick'===a.type||'ohlc'===a.type){const b={plottype:a.type,typeinnavigator:a.typeinnavigator};a.open&&(!p.aggregate._fc_info.first&&(p.aggregate._fc_info.first={}),!p.aggregate._fc_info.first[a.open]&&(p.aggregate._fc_info.first[a.open]=[]),b.open=p.aggregate._fc_info.first[a.open]),a.high&&(!p.aggregate._fc_info.max&&(p.aggregate._fc_info.max={}),!p.aggregate._fc_info.max[a.high]&&(p.aggregate._fc_info.max[a.high]=[]),b.high=p.aggregate._fc_info.max[a.high]),a.low&&(!p.aggregate._fc_info.min&&(p.aggregate._fc_info.min={}),!p.aggregate._fc_info.min[a.low]&&(p.aggregate._fc_info.min[a.low]=[]),b.low=p.aggregate._fc_info.min[a.low]),a.close&&(!p.aggregate._fc_info.last&&(p.aggregate._fc_info.last={}),!p.aggregate._fc_info.last[a.close]&&(p.aggregate._fc_info.last[a.close]=[]),b.close=p.aggregate._fc_info.last[a.close]),b.tableInfo=[p.aggregate._fc_info.first,p.aggregate._fc_info.max,p.aggregate._fc_info.min,p.aggregate._fc_info.last].filter(a=>!!a)[0],b.value=a.value,i.plots.push(b)}else p.aggregate._fc_info[a.aggregation]||(p.aggregate._fc_info[a.aggregation]={}),p.aggregate._fc_info[a.aggregation][a.value]||(p.aggregate._fc_info[a.aggregation][a.value]=[]),i.plots.push({plottype:a.type,typeinnavigator:a.typeinnavigator,tableInfo:p.aggregate._fc_info[a.aggregation],value:p.aggregate._fc_info[a.aggregation][a.value]})})}}},getSmartLinearMin=(a,b)=>{let c=.9*a;return 0<c&&b?0:c},getSmartLogMin=(a,b)=>{let c=.9*a;return b?Math.min(c,1):c},getLogMinMax=(a,b,c,d,e,f)=>{isValidNumber(e)&&0!==e||(e=10);const g=0<a&&isFinite(a)?getSmartLogMin(a,f):1,h=isValidNumber(c)&&0<c&&c<a?c:g,i=0<b&&isFinite(b)?b:g+ +e,j=isValidNumber(d)&&d>h?d:1.2*i;return[h,j]},getLinearMinMax=(a,b,c,d,e)=>{isFinite(a)||(a=UNDEF),isFinite(b)||(b=UNDEF),isFinite(c)||(c=UNDEF),isFinite(d)||(d=UNDEF);const f=c<a?c:a===UNDEF?0:getSmartLinearMin(a,e),g=d>b?d:b===UNDEF?f+1:1.2*b;return[f,g]};class TimeSeries extends CommonAPI{constructor(){super();let a=this;a.addToEnv('getStyleDef',function(b={}){let c,d=a.getFromEnv('textStyle');if('string'==typeof b){let e=a.getFromEnv('dataSource').styledefinition,f={};return e&&b.split(/\s+/g).forEach(a=>extend2(f,e[a.toLowerCase()])),c=f.label||f.text,c&&setLineHeight(c,d['font-size']),f}return c=b.label||b.text,c&&setLineHeight(c,d['font-size']),b}),a.deregisterFactory('canvas'),a.registerFactory('background',backgroundFactory),a.registerFactory('caption',CaptionFactory),a.registerFactory('legend',legendFactory),a.registerFactory('panel',panelFactory),a.registerFactory('selectorToolbar',toolbarFactory,['timeNavigator','canvas']),a.registerFactory('timeNavigator',timeNavigatorFactory),a.registerFactory('standardRangeSelector',standardRangeSelectorFactory,['selectorToolbar']),a.registerFactory('customRangeSelector',CustomRangeFactory,['selectorToolbar']),a.registerFactory('multicanvasCrosslineManager',CrosslineManager,['mouseTracker'])}static getName(){return'timeseries'}getName(){return'timeseries'}__setDefaultConfig(){this.config.skipConfigureIteration={},this.config.canvasAxisMap={},this.config.scaleYDsMap={},this.config.palettecolors=['#5D62B5','#29C3BE','#F2726F','#FFC533','#62B58F','#BC95DF','#67CDF2'],this.config.defaultTextStyle={"font-family":'Source Sans Pro',"font-weight":'normal',"font-style":'normal',"font-size":'12px',fill:'#5F5F5F',"line-height":'13px'},this.addToEnv('textStyle',{"font-family":'sans-serif',"font-size":'10',fill:'#000000',"line-height":'12'})}getDSdef(){return Line}_updateVisuals(){super._updateVisuals(),this.getFromEnv('paper').config.noDefaultAttribs=!0}domainValidator(a,b,c=[]){let d,e,f=this,g=f.getFromEnv('contextScalesX')[0].getBinMin(),h=a[0],i=a[1],j=b[0],k=b[1],l=+a[0],m=+a[1],n=+b[0],o=+b[1];if(c.length&&(d=1<Math.abs(m-l-(+c[1]-+c[0]))?'squeeze':'drag'),l<n&&(h=j,i='drag'===d?new Date(m+(n-l)):i),m>o&&(i=k,h='drag'===d?new Date(l-(m-o)):h),m<n&&(i=j),l>o&&(h=k),l>m&&([h,i]=[i,h]),e=i-h,e>=i-g[0].offset(i,-3*g[1])||e>=g[0].offset(h,3*g[1])-h)return f.fireEvent('domainValidated'),[h,i]}setTooltipStyle(a){let b=this.config,c=this.getFromEnv('toolTipController');c.setStyle({bgColor:convertColor(b.tooltipbgcolor||'FFF',b.tooltipbgalpha||90),rawBgColor:(b.tooltipbgcolor||'FAFAFA').replace(/\s+/g,'').replace(/^#?([a-f0-9]+)/ig,'#$1'),fontColor:(b.tooltipcolor||b.basefontcolor||'737373').replace(/\s+/g,'').replace(/^#?([a-f0-9]+)/ig,'#$1'),borderColor:convertColor(b.tooltipbordercolor||'E8E8E8',b.tooltipborderalpha||90),rawBorderColor:(b.tooltipbordercolor||'E8E8E8').replace(/\s+/g,'').replace(/^#?([a-f0-9]+)/ig,'#$1'),bgAlpha:pluckNumber(b.tooltipbgalpha,90),borderThickness:pluckNumber(b.tooltipborderthickness,1),showToolTipShadow:pluckNumber(b.showtooltipshadow,b.showshadow,1),borderRadius:pluckNumber(b.tooltipborderradius,0),"font-size":b.basefontsize||8,"font-family":b.basefont||pluck(a.basefont,'Source Sans Pro,sans'),padding:pluckNumber(b.tooltippadding||3),borderAlpha:pluckNumber(b.tooltipborderalpha,90)})}configureAttributes(a){const b=this,c=b.getFromEnv('dataSource'),d=b.config,e=new ColorManager(b),f=new OrdinalScale,g=a.chart||{},h=parsePaletteColor(g.palettecolors),i=(a,b)=>a.getSchema().filter(b).map(a=>a.name),j=b.getFromEnv('textStyle'),k=b.getFromEnv('getStyleDef'),l=c.legend,m=k(l&&l.item&&l.item.style&&l.item.style.text);d.mergedLegendStyle=extend2(extend2({},d.defaultTextStyle),m);let n=[],o=[],p=[],q=[];this.addToEnv('chart-attrib',g),e.configure(),this.addToEnv('color-manager',e),h.length&&(d.palettecolors=h),f.setRange(d.palettecolors),this.addToEnv('ordinalScale',f),d.dataTable=a.data,d.showLegend=pluckNumber(g.showlegend,1),d.showTooltip=pluckNumber(g.showtooltip,1),d.navigatorEnabled=pluckNumber(g.enablenavigator,1),d.interCanvasSpace=pluckNumber(g.intercanvasspace,DEFAULT_CANVAS_DISTANCE),n=expanderAxis(i(d.dataTable,isTemporalScheme),a.xaxis,!1).slice(0,1).map(a=>Object.assign({},a,{bin:a.plot.map(a=>a.value)})),d.focusAxesX=n.map(a=>Object.assign({},a,{filter:a.plot.map(a=>a.value),filterInfo:{}})),d.focusAxesY=expanderSeries(i(d.dataTable,isStringyScheme),expanderAxis(i(d.dataTable,isNumericScheme),a.yaxis),a.series).map(a=>a.series?Object.assign({},a,{pivot:[a.series]}):a),d.focusPanels=permuteIndices(expanderPanel(d.focusAxesX,d.focusAxesY,a.canvas,defaultPanels)),p=flatMap(a=>a.series?a.series:a.plot.map(a=>a.value),d.focusAxesY).filter(a=>!!a),p.length&&(o=unique(p),q=d.dataTable.getSchema(),this.addToEnv('legendMap',zipObj(o,o.map(a=>{if('string'===q[d.dataTable.indexOf(a)].type){const b=d.dataTable.unique(a);return zipObj(b,b.map(a=>({visibility:!0,series:a})))}return{visibility:!0,series:a}})))),d.contextAxesX=clone(n),d.contextAxesY=clone(d.focusAxesY),xFactory(this),yFactory(this),d.focusTableMap={_fc_info:{table:new NodeTable(d.dataTable)}},mapper(b),d.navigatorEnabled&&(d.contextPanels=permuteIndices(expanderPanel(d.contextAxesX,d.contextAxesY,[],(a,b)=>a.map((a,c)=>({x:[{index:c}],y:b.map((a,b)=>({index:b,visible:!1}))})))),d.contextTableMap={_fc_info:{table:new NodeTable(d.dataTable)}},mapper(b,!0)),tableCreator(d.focusTableMap),tableCreator(d.contextTableMap),d.printOption={enabled:pluckNumber(g.printshowbutton,g.showprintmenuitem,0)},d.toolbarPosition=toolbarPositionParser(pluck(g.toolbarposition,'tr').toLowerCase()),d.toolbarHAlign='left'===(''+g.toolbarhalign).toLowerCase()?'l':d.toolbarPosition.charAt(1),d.toolbarVAlign='bottom'===(''+g.toolbarvalign).toLowerCase()?'b':d.toolbarPosition.charAt(0),d.link=g.clickurl,this.addToEnv('linkClickFN',getLinkAction(this.getFromEnv('dataSource'),this)),this.addToEnv('chartConfig',d),g.style&&extend2(j,k(g.style.text)),this.addToEnv('style',{outCancolor:j.fill,fontSize:j['font-size'],outCanfontFamily:j['font-family']}),this.createBaseComponent(),this.getFromEnv('animationManager').setAnimationState(this._firstConfigure?'initial':'update'),this._createToolBox(),this.setTooltipStyle(a),this.configureChildren()}_addLegend(a){var b,c,d,e=this,f=e.config,g=f.mergedLegendStyle,h=a.series,i=e.getFromEnv('ordinalScale').getRangeValue(h),j=e.getFromEnv('legend'),k=getLightColor(i,60).replace(dropHash,HASHSTRING);f.showLegend&&(b={FCcolor:{color:i,angle:0,ratio:'0',alpha:'100'}},d=j.getItem(a.legendItemId),c={label:h},!d&&(a.legendItemId=j.createItem(),d=j.getItem(a.legendItemId),e.addExtEventListener('fc-click',function(){const b=e.getDatasets(),c=a.visibility;b.forEach(b=>{b.config.series===h&&(c?(a.visibility=!1,d.setLegendState('hidden')):(a.visibility=!0,d.removeLegendState('hidden')))}),e.config.dataTable._flushResult()},d)),d.configure(c),d.setStateCosmetics('default',{symbol:{fill:toRaphaelColor(b),rawFillColor:i,stroke:toRaphaelColor(k)},text:{fill:g.fill,"font-family":g['font-family'],"font-size":g['font-size'],"font-style":g['font-style'],"font-weight":g['font-weight'],"line-height":g['line-height']}}))}_createGroup(a={},b){const c=this.getFromEnv('animationManager');return c.setAnimation({attr:a,container:b,el:'group',component:this,label:'group'})}_createLayers(){const a=this.getFromEnv('animationManager');let b,c=this.getContainer('parentgroup');c||(c=this.addContainer('parentgroup',a.setAnimation({el:c||'group',attr:{name:'parentgroup'},component:this}))),this.getChildContainer('tropo')||this.addChildContainer('tropo',this._createGroup({name:'chart-tropo'},c)),this.getChildContainer('strato')||this.addChildContainer('strato',this._createGroup({name:'chart-strato'},c)),this.getChildContainer('meso')||this.addChildContainer('meso',this._createGroup({name:'chart-meso'},c)),this.getChildContainer('thermo')||this.addChildContainer('thermo',this._createGroup({name:'chart-thermo'},c)),this.getChildContainer('exo')||(b=this.addChildContainer('exo',this._createGroup({name:'chart-exo'},c))),this.getChildContainer('toolbar-master')||this.addChildContainer('toolbar-master',this._createGroup({name:'toolbar-master'},b)),this.getChildContainer('legendGroup')||this.addChildContainer('legendGroup',this._createGroup({name:'legend-group'},b))}manageSpace(){let a,b,c,d,e,f,g,h,j,i,k,l,m,n=this,o=n.config,p=o.focusPanels,q=o.canvasAxisMap,r=n.getFromEnv('focusScalesY'),s=n.getFromEnv('focusScalesX'),t=n.getChildren('caption'),u=n.getFromEnv('selectorToolbar'),v=n.getFromEnv('toolbar'),w=v.getLogicalSpace(),x=n.getChildren('legend')&&n.getChildren('legend')[0],y=n.getChildren('background')[0],z=n.getChildren('canvas_0'),A=0,B=0,C=n.getChildren('timeNavigator'),D=0,E=0,F=a=+n.getFromEnv('chartWidth'),G=b=+n.getFromEnv('chartHeight'),H=0,I=0,J=.03*a,K=.03*b,L=0,M=o.interCanvasSpace;if(E+=pluckNumber(o.marginTop,K),G-=pluckNumber(o.marginBottom,K),D+=pluckNumber(o.marginLeft,J),F-=pluckNumber(o.marginRight,J),y.setDimension({height:b,width:a}),y.setTranslation(0,0),p.forEach((a,b)=>{let c=q[`canvas_${b}`],{x:d,y:e}=c,f=DEFAULT_AXIS_HEIGHT_RATIO*(F-D)/(e.length||1),g=DEFAULT_AXIS_HEIGHT_RATIO*(G-E)/(d.length||1),i=0,k=0;h=e.map(b=>{let c=getIndex(b),d=n.getChildren(b)[0].setDimension({width:f});return a.y[c].overlap?{}:d}),j=d.map(b=>{let c=getIndex(b),d=n.getChildren(b)[0].setDimension({height:g});return a.x[c].overlap?{}:d}),h.forEach(a=>{i+=pluckNumber(a.left,0),k+=pluckNumber(a.right,0)}),H=safeMax([H,i]),I=safeMax([I,k]),j.forEach(a=>{L+=pluckNumber(a.top,a.bottom,0)})}),D+=H,F-=I,c=G-E,t&&t.length?(f=t[0].setDimension({width:F-D-w.width,height:DEFAULT_CAPTION_HEIGHT_RATIO*c}),t[0].setTranslation(D,E),m=Math.max(f.height,w.height)):m=w.height,w.height&&(v.setDimension({x:F-w.width,y:E}),v.manageSpace()),E+=m,l=u.getLogicalSpace().height,u.setDimension({x:D,y:E,width:F-D}),u.manageSpace(),E+=l,g=L+(p.length-1)*M,c=G-E-g,d=F-D,x&&(k=x.setDimension({height:c*DEFAULT_LEGEND_RATIO,width:d}).height,G-=k,c-=k,x.setTranslation(D,G)),C&&C.length&&(i=DEFAULT_TIMENAV_HEIGHT_RATIO*c/(C.length||1),C.forEach((a,b)=>{a.setDimension({width:d,height:i}),a.setTranslation(D,G-(C.length-b)*i)}),c-=DEFAULT_TIMENAV_HEIGHT_RATIO*c),e=c/(p.length||1),z&&z[0]){const a=z[0].getCanvasBorder();A=a.topBorder+a.bottomBorder,B=a.leftBorder+a.rightBorder}r.forEach(a=>a.setRange([e-A-CANVAS_TOP_PADDING,0])),s.forEach(a=>a.setRange([0,d-B])),p.forEach((a,b)=>{let c=`canvas_${b}`,{x:f,y:g}=q[c],{x:h,y:i}=a,j=D,k=D+d,l=n.getChildren(c)[0],m=l.getCanvasBorder(),o=E+m.topBorder,p=o+e,r=[];l.setPadding({top:CANVAS_TOP_PADDING}),l.setDimension({width:d,height:e}),f.forEach(a=>{let b=h[getIndex(a)],c=n.getChildren(a)[0],d=c.getDimension();return b.overlap?void r.push(a):void('top'===b.align?(c.setTranslation(D+m.leftBorder,o),o+=d.height):'bottom'===b.align&&(c.setTranslation(D+m.leftBorder,p),p+=d.height))}),l.setTranslation(D,o),r.forEach(a=>{let b=h[getIndex(a)],c=n.getChildren(a)[0],d=c.getDimension();'top'===b.align?c.setTranslation(D+m.leftBorder,o):'bottom'===b.align&&c.setTranslation(D+m.leftBorder,o+e-d.height)}),g.forEach(a=>{const b=o+CANVAS_TOP_PADDING;let c=i[getIndex(a)],e=n.getChildren(a)[0],f=e.getDimension();c.overlap?'left'===c.align?e.setTranslation(D,b):'right'===c.align&&e.setTranslation(D+d-f.width,b):'left'===c.align?(j-=f.width,e.setTranslation(j,b)):'right'===c.align&&(e.setTranslation(k,b),k+=f.width)}),E=p+M})}_setDataLabelStyle(){return this}_checkInvalidData(){const a=this.getFromEnv('dataSource'),b=this.getFromEnv('chartInstance');return!a.data&&(b.__state.dataReady=!1,b.jsVars.hasNativeMessage=!0,b.jsVars.drawCount+=1,!0)}_checkInvalidSpecificData(){const a=this.getFromEnv('dataSource');if(a.data&&'function'==typeof a.data.getData){let{data:b,schema:c}=a.data.getData();return!(Array.isArray(b)&&0!==b.length&&Array.isArray(c)&&c.filter(a=>'date'===a.type).length)}return!0}setYScaleLimit(a,b,c,d=!0){let e,f,g,h,j=this,i=j.config,k=i.scaleYDsMap,l=k[a],m=({scale:b})=>b&&b.getId()===a,n=i.focusAxesY.find(m),o=i.contextAxesY.find(m),p=n||o,q=p.scale;for(const i in l||(l=k[a]={}),(e=l[b])||(e=l[b]={}),e.limit=c,e.baseRequired=d,l)if(l.hasOwnProperty(i)){const a=l[i];[f,g]=extent([f,g].concat(a.limit)),h=h||a.baseRequired}'log'===q.getType()?q.setDomain(getLogMinMax(f,g,p.min,p.max,p.base,h)):q.setDomain(getLinearMinMax(f,g,p.min,p.max,h)),j.config.focusPanels.forEach((a,b)=>{let c=`canvas_${b}`,d=j.getChildren(c),e=d&&d[0],f=j.config.canvasAxisMap[c],g=f&&f.y;g&&e&&(e.asyncDraw(),g.forEach(a=>{const b=j.getChildren(a);b.forEach(a=>{a.getScale()===q&&(a.placeAxis(),a.asyncDraw())})}))})}setXScaleLimit(a,b,c){let d,e,f,g,h,j=this,i=j.config,k=i.scaleYDsMap,l=k[a],[m,n]=j.getContextLimit(),o=({scale:b})=>b&&b.getId()===a,p=i.focusAxesX.find(o),q=i.contextAxesX.find(o),r=(p||q).scale;for(const g in l||(l=k[a]={}),(d=l[b])||(d=l[b]={}),d.limit=c,l)if(l.hasOwnProperty(g)){const a=l[g];[e,f]=extent([e,f].concat(a.limit))}p?([g,h]=j.getFocusLimit(),g===m&&isValidNumber(e)&&(g=Math.min(g,e)),h===n&&isValidNumber(f)&&(h=Math.max(h,f)),r.setDomain([g,h])):r.setDomain(extent([e,f,m,n],Number)),j.config.focusPanels.forEach((a,b)=>{let c=`canvas_${b}`,d=j.getChildren(c),e=d&&d[0],f=j.config.canvasAxisMap[c],g=f&&f.x;g&&e&&(e.asyncDraw(),g.forEach(a=>{const b=j.getChildren(a);b.forEach(a=>{a.getScale()===r&&(a.placeAxis(),a.asyncDraw())})}))})}setFocusLimit(a=[]){const b=this,c=b.config,d=this.domainValidator(a.slice(),this.getContextLimit(),c.focusLimit),e=c.focusAxesX[0],f=this.getFromEnv('focusScalesX')[0],g=f.getRangeThreshold();d&&(c.focusLimit=d,f.setBinDomain(d),this.fireEvent('focusLimitChanged'),e.filterInfo&&e.filterInfo.query&&(e.filterInfo.query._updateArgs(+d[0]-2*+g[2],+d[1]+2*+g[2]),e.filterInfo.table._data=null,e.filterInfo.table.getTable()._flushResult()))}getFocusLimit(){return this.config.focusLimit.slice()}setContextLimit(a=[]){this.config.contextLimit=a.slice(),this.getFromEnv('contextScalesX')[0].setBinDomain(a)}getContextLimit(){return this.config.contextLimit.slice()}}export default TimeSeries;