import SmartRenderer from'../../../../../fc-core/src/component-interface/smart-renderer';import timeConverter from'../../../../../fc-utils/src/time-converter';import{pluck,extend2,parseUnsafeString,defined,DEFAULT_FT_FONT}from'../../../../../fc-core/src/lib';import{convertColor}from'../../../../../fc-core/src/lib/lib-graphics';import{getMinPlaceHolder,getPlaceHolderIndex,getFilterdTimeFormat}from'../../../../../fc-utils/src/time-bucket';import isValidNumber from'../../../../../fc-utils/src/type/is-valid-number';let pathStr='M12.4444444,0 L1.55555556,0 C0.7,0 0,0.654545455 0,1.45454545 L0,10.8363636 C0,11.3454545 0.233333333,11.7817897 0.7,12.0727273 L7,16 L13.3,12.0727273 C13.6888889,11.7818182 14,11.3454545 14,10.8363636 L14,1.45454545 C14,0.654545455 13.3,0 12.4444444,0 Z',flagHeight=16,stickLength=10,flagWidth=16,VISIBLE='visible',_getMarkerIndex=function(a,b,c){let d,e,f=[Math.ceil(a),Math.floor(a)];return f.forEach(a=>{void 0===e&&(d=b[a])&&isValidNumber(d.value)&&c>=d.startDate&&c<=d.endDate&&(e=a)}),e},getHoverInConfig=function(a){return{style:{"forced-stroke-opacity":100,"forced-fill-opacity":100},index:a,skipGrouping:!0}},getHoverOutConfig=function(a){return{style:{"applicable-stroke-opacity":50,"applicable-fill-opacity":50,"forced-stroke-opacity":void 0,"forced-fill-opacity":void 0},index:a,skipGrouping:!0}};class FlagMarker extends SmartRenderer{configure(a){super.configure(a);var b,c,d=this,e=d.config,f=e.styleInfo;if(a.data&&(this.config.data=a.data),c=a.style)for(let d in b=f[a.index]||(f[a.index]={}),c)b[d]=c[d];e.skipGrouping=a.skipGrouping,defined(a.visibility)&&(e.visibility=a.visibility)}constructor(){super(),this._getMarkerBounds=function(){return{width:flagWidth,height:26}},this.config.styleInfo={}}setHoverInEffect(a){this.getFromEnv('animationManager').setAnimationState('mouseOver'),this.setData(getHoverInConfig(a))}setHoverOutEffect(a){this.getFromEnv('animationManager').setAnimationState('mouseOut'),this.setData(getHoverOutConfig(a))}__setDefaultConfig(){var a=this.config;a['default-stroke-width']=1,a['default-fill-opacity']=50,a['default-stroke-opacity']=50,a['default-font-color']='#ffffff',a['default-stroke-color-multiple']='#8c8c8c',a['default-stroke-color']='#ffffff',a['default-font-opacity-fill']=1,a['default-font-opacity-stroke']=.1,a['default-font-family']=DEFAULT_FT_FONT,a['default-font-size']='12px',a['default-tooltip-background']='#f2eded'}draw(){this.config.visibility===VISIBLE&&(this._createGroup(),this._drawMarkers())}getType(){return'dataMarker'}getName(){return'flagMarker'}_checkPointOverMarker(a,b,c,d){for(var e,f,g,h,i,j,k=this,l=k.config,m=l.dataInfo,n=k._getMarkerBounds(),o=l.markerInfo,p=Math.ceil(a),q=Math.floor(a),r=d,s=[p,q];r<n.width;)s.unshift(++p),s.push(--q),r+=d;return s.forEach(a=>{!j&&o[a]&&(e=m[a],f=e.x,g=e.y,h=(e.width||0)/2,i=f+h,b>=i-n.width/2&&b<=i+n.width/2&&c<=g&&c>=g-n.height&&(j={pointIndex:a,hovered:!0,pointObj:e,markerObj:o[a],component:k}))}),j}_getTooltext(a){var b,c,d,e,f=this,g=f.config,h=g.markerInfo,i=h[a],j=i.markers,k=i.multipleMarkers;return i.formatedTime||(k?(b=f.getFromEnv('xScale'),c=b.getRangeThreshold(),d=c[0]._name,i.formatedTime=timeConverter.formatter(getFilterdTimeFormat('%b %d, %Y %H:%M:%S:%L:%f',d)).format(new Date(i.startDate))):i.formatedTime=j[0].time),i.tooltipValue||(i.tooltipValue=f.getFromEnv('yScale').tickFormat(4,'.2s')(i.value)),e=`<div style='font-size: 12px';'>${i.formatedTime}</div>`,e+=`<div style='margin-top:3px; margin-bottom:2px; height: 14px; font-size: 10px;'>
    <div style='float: left; font-size: 23px; line-height: 0.5; color:${i.fill}'>â– &nbsp</div>
    <div style='float: left;'>${i.seriesname}&nbsp</div>
    <div style='float: right;'>&nbsp${i.tooltipValue}</div>
    </div>`,j.forEach(a=>{k&&(e+=`<div style='clear: both; margin-bottom:4px; font-size: 11px'};'>${a.time}</div>`),e+=a.tooltext?`<div style='clear: both; margin-bottom:6px; font-size: 10px;
      background-color:${k?g['default-tooltip-background']:''};'>${parseUnsafeString(a.tooltext)}</div>`:''}),e}allocatePosition(){this.config.skipGrouping||this._groupMarkers(),this._mergeStyle()}_mergeStyle(){var a,b=this,c=b.config,d=c.markerInfo,e=c.styleInfo;for(a in d)e[a]&&extend2(d[a],e[a])}_groupMarkers(){var a,b,c,d,e,f=this,g=f.getLinkedParent(),h=g._getRelevantInfo(),i=h.firstTimeStamp,j=h.timeStampGap,k=h.dataInfo,l=f.config,m=l.markerInfo={},n=f.getFromEnv('xScale'),o=n.getRangeThreshold(),p=o[0]._name,q=l.data;l.dataInfo=k,q.forEach(f=>{d=timeConverter.parser(f.timeformat).parse(f.time),e=getPlaceHolderIndex(p)-getPlaceHolderIndex(getMinPlaceHolder(f.timeformat)),d&&0<=e&&1>=e&&(d=d.getTime(),d>=i&&(c=(d-i)/j,b=_getMarkerIndex(c,k,d),b!==void 0&&(!m[b]&&(a=m[b]={markers:[],id:f.seriesname+f.time,startDate:k[b].startDate,seriesname:f.seriesname}),a.markers.push(f),1<a.markers.length&&(a.multipleMarkers=!0))))})}_createGroup(){var a=this,b=a.config,c=a.getLinkedParent().config;a.addGraphicalElement({el:'group',container:{label:'group',id:'thermo',isParent:!0},component:a,label:'group',attr:{name:'markerGroup-thermo',"stroke-width":b['default-stroke-width'],fill:c.strokeColor||c.fillColor,stroke:c.strokeColor||c.fillColor,"fill-opacity":b['default-fill-opacity']/100,"stroke-opacity":b['default-stroke-opacity']/100,"font-size":b['default-font-size'],"font-family":b['default-font-family']}})}_drawMarkers(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q=this,r=q.config,s=r.dataInfo,t=q.getFromEnv('getStyleDef'),u={},v={},w={},z=q.getLinkedParent(),A=z._getRelevantInfo(),B=r.markerInfo;for(h in B)b=s[h],g=B[h],p=g.multipleMarkers,l=g.id,a=b.y,d=b.x,e=b.width||0,i=d+e/2,o=a-stickLength,p?g.fill=j=k=convertColor(r['default-stroke-color-multiple'],pluck(g['forced-fill-opacity'],g['applicable-fill-opacity'],r['default-fill-opacity'])):(f=g.markers[0],u=t(f.style)||{},v=u.marker||{},w=u.text||{},k=j=v.fill||g['forced-fill-opacity']||g['applicable-fill-opacity']?convertColor(pluck(v.fill,A.fill),pluck(g['forced-fill-opacity'],v['fill-opacity'],g['applicable-fill-opacity'],r['default-fill-opacity'])):void 0,g.fill=pluck(k,A.fill)),g.value=b.value,n={path:['M',i,a,'V',o]},j&&(n.stroke=j),q.addGraphicalElement({el:'path',container:{label:'group'},id:l,attr:n,label:'flagStick'},!0),n={path:pathStr,transform:`t${i-8+1},${o-flagHeight}`},j&&(n.stroke=j),k&&(n.fill=k),q.addGraphicalElement({el:'path',container:{label:'group'},id:l,attr:n,label:'flagTriangle'},!0),(p||(m=f.identifier))&&(c=convertColor(pluck(w.fill,r['default-font-color'])),n={text:p?g.markers.length:m.charAt(0),x:i,y:o-8,fill:c,stroke:c,"fill-opacity":r['default-font-opacity-fill'],"stroke-opacity":r['default-font-opacity-stroke'],"text-anchor":'middle'},w['font-family']&&(n['font-family']=w['font-family']),w.opacity&&(n.opacity=w.opacity),w['font-weight']&&(n['font-weight']=w['font-weight']),q.addGraphicalElement({el:'text',container:{label:'group'},id:l,attr:n,label:'markerText'},!0));q.styleInfo={}}}export default FlagMarker;