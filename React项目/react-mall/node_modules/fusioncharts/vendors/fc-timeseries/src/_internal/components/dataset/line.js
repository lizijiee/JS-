import Column from'./column';import{pluck,pluckNumber,polyPathToPath,UNDEF,defined}from'../../../../../fc-core/src/lib';import LineGenerator from'../../../../../fc-utils/src/shape-generators/line-generator';import AreaGenerator from'../../../../../fc-utils/src/shape-generators/area-generator';import CurveMonotoneX from'../../../../../fc-utils/src/shape-generators/curve-factories/monotone';import LinearCurve from'../../../../../fc-utils/src/shape-generators/curve-factories/linear';import StepCurve from'../../../../../fc-utils/src/shape-generators/curve-factories/step';import{convertColor}from'../../../../../fc-core/src/lib/lib-graphics';import isValidNumber from'../../../../../fc-utils/src/type/is-valid-number';import{addDep}from'../../../../../fc-core/src/dependency-manager';import lineAnimation from'./line.animation';const HOVERED_ANCHOR_RADIUS=3.5,PLOT_HOVERED_ANCHOR_RADIUS=5.5,calculateMid=(c,a)=>(c+a)/2;let maxRadius=5,LINE='line',AREA='area',WHITE='#ffffff',isWithinShape=function(a,b,c,d,e){var f,g,h,i,j,k=Math.pow;return a?(f=a.x,g=a.y,h=c-f,i=d-g,j=Math.sqrt(k(h,2)+k(i,2)),{pointIndex:b,hovered:j<=maxRadius,pointObj:a,component:e}):{pointIndex:b,hovered:!1,component:e}};function getGenerator(a){switch(a){case'area':case'smooth-area':case'step-area':return new AreaGenerator;case'line':case'smooth-line':case'step-line':default:return new LineGenerator;}}function getCurve(a){switch(a){case'smooth-line':case'smooth-area':return CurveMonotoneX;case'step-area':case'step-line':return StepCurve;case'line':case'area':default:return LinearCurve;}}function getGenericType(a){return'line'===a||'smooth-line'===a||'step-line'===a?LINE:'area'===a||'smooth-area'===a||'step-area'===a?AREA:void 0}addDep({name:'lineAnimation',type:'animationRule',extension:lineAnimation});class Line extends Column{constructor(){super(),this.getHoverInConfig=function(a,b){return{index:a,hovered:!0,radius:b?PLOT_HOVERED_ANCHOR_RADIUS:HOVERED_ANCHOR_RADIUS}},this.getHoverOutConfig=function(a){return{index:a,hovered:!1}}}getName(){return'continuous'}__setDefaultConfig(){super.__setDefaultConfig(),this.config['default-stroke-width']=2,this.config['default-stroke-linecap']='round',this.config['default-stroke-linejoin']='miter',this.config['default-stroke-dasharray']='none',this.config['default-stroke']='9194CC',this.config['default-stroke-opacity']=100,this.config['default-fill']='9194CC',this.config['default-fill-opacity']=60,this.config['anchor-stroke']=convertColor(WHITE),this.config['anchor-stroke-white']=2,this.config.type='line'}configureAttributes(a){let b,c,d=this,e=d.config,f=d.getFromEnv('dataSource');if(a.hasOwnProperty('index'))a.hovered?(e.mode='show',e.sharedAnchorIndex=a.index):(e.mode='hide',e.hideIndex=e.lastShownIndex),e.radius=a.radius;else{for(b in a)if('primaryColor'===b){let g=f.plotconfig&&f.plotconfig[a.type]||{},h=a[b],i=d.getFromEnv('getStyleDef')(g);for(c in i)e[c]=pluck(i[c],e[`default-${c}`]);e.fillColor=getGenericType(a.type)===AREA?convertColor(pluck(i.fill,i.stroke,h,e['default-fill']),pluckNumber(e['fill-opacity'],e['default-fill-opacity'])):'none',e.strokeColor=convertColor(pluck(i.fill,i.stroke,h,e['default-stroke']),pluckNumber(e['stroke-opacity'],e['default-stroke-opacity']))}else e[b]=a[b];e.limit=d._calculateLimits();const g=d.getFromEnv('chart');g.setYScaleLimit(e.scaleY.getId(),d.getId(),e.limit.y,e.limit.baseRequired),g.setXScaleLimit(e.scaleX.getId(),d.getId(),e.limit.x)}}allocatePosition(){let a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,d=this,r=d.config,[s,t,u,v]=r.indices,w=r.type,x=r.data,z=r.dataInfo,A=[],B=d.getFromEnv('xScale'),C=d.getFromEnv('yScale'),D=B.getRangeThreshold()[2],E=x.length,[F,G]=B.getDomain();if(d._isRepositioningNeeded()){if('visible'!==r.visibility)return;z=r.dataInfo=[],r.timeStampGap=k=D,r.availableWidth=B.getRangeValue(D)-B.getRangeValue(0),p=+B.getDomainValue(PLOT_HOVERED_ANCHOR_RADIUS)-+B.getDomainValue(0),r.actualStartDomain=+F-p,r.actualEndDomain=+G+p,x.forEach((b,d,x)=>{q=b[s],i=b[t],c=q.start,e=q.end,f=calculateMid(c,e),g=x[d+1],o=b[u],m=C.getRangeValue(o||Math.max(C.getDomain()[0],0)),n=C.getRangeValue(i),d||(j=r.firstTimeStamp=c);(w!==AREA||isValidNumber(m))&&(isValidNumber(i)&&isValidNumber(n)?(l=Math.round((c-j)/k),a={startDate:c,endDate:e,midDate:f,value:i,paddingInTimestamp:p,yBaseValue:w===AREA?o:void 0,x:B.getRangeValue(f),totalStackSum:defined(b[v])?b[v]:UNDEF,y:n,base:m,eventArgs:{index:d,dataValue:i}},z[l]=a,g?(A.push(a),h=calculateMid(g[s].start,g[s].end),h-f>1.5*D&&A.push(null)):1==E-d&&A.push(a)):A.push(null))}),b=getGenerator(w).setCurve(getCurve(w)).setDefined(a=>!!a).setXAccessor((a,b)=>A[b].x).setYAccessor((a,b)=>A[b].y),b.setYBaseAccessor&&b.setYBaseAccessor((a,b)=>A[b].base),r.path=b.generate(A),r.topPath=b.getLineYTop&&b.getLineYTop().generate(A)}}_isInvalidTooltext(a){let b=this,c=b.config;if(!a||a.midDate<c.actualStartDomain||a.midDate>c.actualEndDomain)return!0}_drawPlot(){let a,b=this,c=b.config,d=c.dataInfo;b.addGraphicalElement({el:'group',container:{id:'meso',label:'group'},component:b,label:'group',id:'meso-line',attr:{name:'line-common-meso',"stroke-dasharray":c['stroke-dasharray']||c['default-stroke-dasharray'],"stroke-width":c['stroke-width']||c['default-stroke-width'],stroke:getGenericType(c.type)===AREA?'none':c.strokeColor,fill:c.fillColor,"stroke-linecap":c['stroke-linecap']||c['default-stroke-linecap'],"stroke-linejoin":c['stroke-linejoin']||c['default-stroke-linejoin'],visibility:c.visibility}}),b.addGraphicalElement({el:'group',container:{id:'meso-line',label:'group'},component:b,label:'group',id:'meso-plot',attr:{name:'line-plot-meso'}},!0),b.addGraphicalElement({el:'group',container:{id:'meso-line',label:'group'},component:b,label:'group',id:'meso-anchor',attr:{name:'line-anchor-meso'}},!0),b.addGraphicalElement({el:'path',container:{label:'group',id:'meso-plot'},attr:{path:c.path},label:'path',component:b},!0),c.topPath&&b.addGraphicalElement({el:'path',container:{label:'group',id:'meso-plot'},attr:{path:c.topPath,fill:'none',stroke:c.strokeColor,"stroke-width":c['stroke-width']||c['default-stroke-width']},label:'topPath',component:b},!0),'show'===c.mode?!isNaN(c.sharedAnchorIndex)&&(a=d[c.sharedAnchorIndex],c.lastShownIndex=c.sharedAnchorIndex,a&&!isNaN(a.value)&&b.addGraphicalElement({el:'path',container:{label:'group',id:'meso-anchor'},attr:{path:polyPathToPath([2,a.x,a.y,c.radius,0,0]),fill:c.strokeColor,"stroke-width":c['anchor-stroke-width'],stroke:c['anchor-stroke'],visibility:'show'},id:'shared-anchor',label:c.dsType+'-anchor'})):!isNaN(c.hideIndex)&&(a=d[c.hideIndex],a&&!isNaN(a.value)&&b.addGraphicalElement({el:'path',container:{label:'group',id:'meso-anchor'},attr:{visibility:'hidden'},id:'shared-anchor',label:c.dsType+'-anchor'}))}setHoverInEffect(a,b){this.getFromEnv('animationManager').setAnimationState('mouseOver'),this.setData(this.getHoverInConfig(a,b),!0)}_getHoveredPlot(a,b){var c,d,e,f,g,h,i,k=Math.ceil,l=Math.floor,m=this,n=m.getFromEnv('xScale'),o=[m.getChildren('pinMarker'),m.getChildren('flagMarker')],p=m.config,q=p.dataInfo,r=q.length,s=m.getLinkedParent(),t=s.getTranslation(),u=t.x,v=t.y;if(a-=u,b-=v,i=n.getDomainValue(a-maxRadius).getTime(),h=(i-p.firstTimeStamp)/p.timeStampGap,d=l(Math.max(h,0)),i=n.getDomainValue(a+maxRadius).getTime(),h=(i-p.firstTimeStamp)/p.timeStampGap,e=k(Math.min(h,r-1)),o.forEach(c=>{!f&&c&&(c=c[0])&&(f=c._checkPointOverMarker(h,a,b,p.availableWidth))}),!f)for(g=e;g>=d&&(c=q[g],f=isWithinShape(c,g,a,b,m),!f.hovered);g--);return f||(f={}),f.hovered?f.binIndexHovered=f.pointIndex:(f.binIndexHovered=l((n.getDomainValue(a).getTime()-p.firstTimeStamp)/p.timeStampGap),f.pointObj=p.dataInfo[f.binIndexHovered]||{startDate:p.firstTimeStamp+l(h)*p.timeStampGap,endDate:p.firstTimeStamp+k(h)*p.timeStampGap}),f}}export default Line;