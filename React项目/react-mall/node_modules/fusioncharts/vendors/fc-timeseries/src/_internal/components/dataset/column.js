import SmartRenderer from'../../../../../fc-core/src/component-interface/smart-renderer';import{pluckNumber,pluck,hasTouch,TOUCH_THRESHOLD_PIXELS,defined,CLICK_THRESHOLD_PIXELS,getMouseCoordinate,extend2,UNDEF,convertColor,safeMin,safeMax}from'../../../../../fc-core/src/lib';import markerFactory from'../../factories/marker-factory';import isValidNumber from'../../../../../fc-utils/src/type/is-valid-number';import{addDep}from'../../../../../fc-core/src/dependency-manager';import columnAnimation from'./column.animation';const DEFAULT_HOVER_ALPHA_RATIO=.8,ROLLOVER='DataPlotRollOver',ROLLOUT='DataPlotRollOut',CLICK='DataPlotClick';var HTP=hasTouch?TOUCH_THRESHOLD_PIXELS:CLICK_THRESHOLD_PIXELS;addDep({name:'columnAnimation',type:'animationRule',extension:columnAnimation});class Column extends SmartRenderer{constructor(){super(),this.registerFactory('markerFactory',markerFactory),this._getFirstValidData=function(a,b){let c,d=a.length;for(c=0;c<d;c++)if(a[0]&&a[0][b]!==void 0)return a[0][b]},this.getHoverInConfig=function(a){let b=this.config;return{style:{"fill-opacity":pluckNumber(b['fill-opacity'],b['default-opacity'])*DEFAULT_HOVER_ALPHA_RATIO,"stroke-opacity":pluckNumber(b['stroke-opacity'],b['default-opacity'])*DEFAULT_HOVER_ALPHA_RATIO},index:a,hovered:!0}},this.getHoverOutConfig=function(a){let b=this.config;return{style:{"fill-opacity":pluckNumber(b['fill-opacity'],b['default-opacity']),"stroke-opacity":pluckNumber(b['stroke-opacity'],b['default-opacity'])},index:a,hovered:!1}},this.config.hoverInfo=[]}getType(){return'dataset'}getName(){return'column'}__setDefaultConfig(){super.__setDefaultConfig();let a=this,b=a.config;b['default-plotSpacePercent']=30,b['default-stroke']='9194CC',b['default-stroke-width']=1,b['default-opacity']=100,b.visibility='visible',b['default-stroke-linecap']='round',b['default-stroke-linejoin']='miter',b['default-stroke-dasharray']='none',b.prevBoundaryInfo={},b.prevDataInfo=[]}configureAttributes(a){let b,c=this,d=c.getFromEnv('dataSource'),e=c.getFromEnv('chart-attrib'),f=c.config;if(a.hasOwnProperty('index'))f.hoverInfo.push(a);else{for(b in a)if('primaryColor'===b){let e,g=d.plotconfig&&d.plotconfig[c.getName()]||{},h=a[b],i=c.getFromEnv('getStyleDef')(g);for(e in i)f[e]=pluck(i[e],f[`default-${e}`]);f['stroke-opacity']=pluckNumber(f['stroke-opacity'],f['default-opacity']),f.strokeColor=convertColor(pluck(i.stroke,i.fill,h,f['default-stroke']),f['stroke-opacity']),f['fill-opacity']=pluckNumber(f['fill-opacity'],f['default-opacity']),f.fillColor=convertColor(pluck(i.fill,i.stroke,h,f['default-stroke']),f['fill-opacity']),f.plotBorderThickness=pluckNumber(i['stroke-width'],f['default-stroke-width'])}else f[b]=a[b];f.limit=c._calculateLimits();const g=c.getFromEnv('chart');g.setYScaleLimit(f.scaleY.getId(),c.getId(),f.limit.y,f.limit.baseRequired),g.setXScaleLimit(f.scaleX.getId(),c.getId(),f.limit.x),f.plotSpacePercent=pluckNumber(e.plotspacepercent,f['default-plotSpacePercent'])}}_calculateLimits(){let{indices:a,data:b,type:c}=this.config,d=b[0],e=b[b.length-1],f='visible'===this.config.visibility;return{x:f?[d&&d[a[0]].start,e&&e[a[0]].end]:UNDEF,y:f?[safeMin(b,b=>pluckNumber(b[a[2]]||b[a[1]])),safeMax(b,b=>b[a[1]])]:UNDEF,baseRequired:!/line/.test(c)}}draw(){this._createContainer(),this._drawPlot(),this.config.hoverInfo=[]}legendInteractivity(){'visible'===this.config.visibility?this.hide():this.show()}_createContainer(){let a=this;a.addGraphicalElement({el:'group',container:{id:'meso',label:'group',isParent:!0},component:a,label:'group',id:'meso',attr:{name:'dataset-meso'}},!0),a.addGraphicalElement({el:'group',container:{id:'thermo',label:'group',isParent:!0},component:a,label:'group',id:'thermo',attr:{name:'dataset-thermo',"clip-path":a.getFromEnv('dsGroupclipPath')}},!0)}_drawPlot(){var a=this,b=a.config,c=b.dataInfo;a.addGraphicalElement({el:'group',container:{id:'meso',label:'group'},component:a,label:'group',id:'meso-plot',attr:{name:'column-plot-meso',stroke:b.strokeColor,fill:b.fillColor,visibility:b.visibility,"stroke-width":b.plotBorderThickness,"stroke-linecap":b['stroke-linecap']||b['default-stroke-linecap'],"stroke-linejoin":b['stroke-linejoin']||b['default-stroke-linejoin'],"stroke-dasharray":b['stroke-dasharray']||b['default-stroke-dasharray']}},!0),c.forEach((b,c)=>{isValidNumber(b.value)&&a.addGraphicalElement({el:'rect',container:{label:'group',id:'meso-plot'},label:'rect',attr:{x:b.x,y:b.y,height:b.height,width:b.width,"fill-opacity":b['fill-opacity'],"stroke-opacity":b['stroke-opacity']},component:a,index:c},!0)})}_isRepositioningNeeded(){let a,b=this,c=b.config,d=b.getFromEnv('xScale'),[e,f]=d.getDomain(),g=c.prevBoundaryInfo,h=c.limit.y||[],i=c.prevDataInfo;return(+e!=+g.domainStart||+f!=+g.domainEnd||c.prevVisibility!==c.visibility||h[0]!==i[0]||h[1]!==i[1])&&(a=!0),c.prevBoundaryInfo={domainStart:e,domainEnd:f},c.prevVisibility=c.visibility,c.prevDataInfo[0]=i[0],c.prevDataInfo[1]=i[1],a}allocatePosition(){var a=Math.round,b=Math.max;let c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,z=this,A=z.config,[B,C,D,E]=A.indices,F=z.getFromEnv('xScale'),G=z.getFromEnv('yScale'),H=A.dataInfo,I=A.groupIndex||0,J=A.totalGroups||1,K=A.data,L=A.plotBorderThickness,M=A.fillColor===A.strokeColor&&0<L,N=F.getRangeThreshold()[2],[O,P]=F.getDomain();if(z._isRepositioningNeeded()){if('visible'!==A.visibility)return;H=A.dataInfo=[],A.availableWidth=r=F.getRangeValue(N)-F.getRangeValue(0),A.timeStampGap=s=N,p=b(r*(1-A.plotSpacePercent/100),1),d=p/J,t=a(J/2),u=0==J%2?0:.5,o=0<t-I?-d*(t-I-u):d*(t-I+u),v=+F.getDomainValue(r*(A.plotSpacePercent/200))-+F.getDomainValue(0),A.actualStartDomain=+O+v,A.actualEndDomain=+P-v,M&&(d=b(d-L,1)),K.forEach((l,p)=>{e=l[B],f=l[C],p||(q=A.firstTimeStamp=e.start),i=l[D],k=G.getRangeValue(i||b(G.getDomain()[0],0)),j=G.getRangeValue(f),isValidNumber(f)&&isValidNumber(k)&&isValidNumber(j)&&(g=1>=e.end-e.start?F.getRangeValue(new Date(e.start)):(F.getRangeValue(new Date(e.end))+F.getRangeValue(new Date(e.start)))/2,M&&(g+=L/2),g+=o,c=Math.abs(k-j),m=j>k,h=m?k:j,w={startDate:e.start,endDate:e.end,value:f,yBaseValue:i,x:g,y:h,width:d,height:c,totalStackSum:defined(l[E])?l[E]:UNDEF,eventArgs:{index:p,dataValue:f},"stroke-opacity":pluckNumber(A['stroke-opacity'],A['default-opacity'],100)/100,"fill-opacity":pluckNumber(A['fill-opacity'],A['default-opacity'],100)/100},n=a((e.start-q)/s),H[n]=w)})}(l=A.hoverInfo)&&l.forEach(a=>{'object'==typeof H[a.index]&&'object'==typeof a.style&&(H[a.index]['stroke-opacity']=a.style['stroke-opacity']/100,H[a.index]['fill-opacity']=a.style['fill-opacity']/100)})}_getRelevantInfo(){var a=this.config;return{firstTimeStamp:a.firstTimeStamp,timeStampGap:a.timeStampGap,dataInfo:a.dataInfo,fill:a.strokeColor}}_getHoveredPlot(a,b){var c,d,e,f,g,h,i=Math.floor,j=this,k=j.getFromEnv('xScale'),l=j.getLinkedParent(),m=j.config,n=j.getChildren('flagMarker'),o=l.getTranslation(),p=o?o.x:0,q=o?o.y:0;if(defined(m.firstTimeStamp))return a-=p,b-=q,c=k.getDomainValue(a).getTime(),h=(c-m.firstTimeStamp)/m.timeStampGap,1>=m.timeStampGap&&-1===h&&(h=0),d=Math.ceil(h),e=i(h),n&&(n=n[0])&&(f=n._checkPointOverMarker(h,a,b,m.availableWidth)),g=f,g||(g=j._checkPointerOverColumn(d,a,b)),g.hovered||(g=j._checkPointerOverColumn(e,a,b)),g.hovered?g.binIndexHovered=g.pointIndex:(g.binIndexHovered=i(h),g.pointObj=m.dataInfo[g.binIndexHovered]||{startDate:m.firstTimeStamp+e*m.timeStampGap,endDate:m.firstTimeStamp+d*m.timeStampGap}),g}_getTooltext(a,b,c){var d,e,f=this,g=f.config,h=g.dataInfo,i=h[c],j=a?b?1:.5:1;return f._isInvalidTooltext(i)?'':(i.tooltipValue||(d=isValidNumber(i.yBaseValue)?0<=i.yBaseValue?i.value-i.yBaseValue:i.yBaseValue-i.value:i.value,i.tooltipValue=isValidNumber(d)?g.formatterFn({value:d,type:'tooltip',prefix:g.prefix,suffix:g.suffix}):''),e=`<div style='margin-top:3px; margin-bottom:2px; color:#5F5F5F; height: 14px; font-size: 10px;opacity:${j}'>
      <div style='float: left; font-size: 23px; line-height: 0.5; color:${g.strokeColor}'>â– &nbsp</div>
      <div style='float: left;'>${g.series}&nbsp</div>
      <div style='float: right;'>&nbsp${i.tooltipValue||''}</div>
      </div>`,e)}_isInvalidTooltext(a){let b=this,c=b.config;if(!a||a.endDate<c.actualStartDomain||a.startDate>c.actualEndDomain)return!0}_getDateForToolText(a){var b=this,c=b.config,d=c.dataInfo,e='',f='',g=d[a];return b._isInvalidTooltext(g)?'':(g.tooltextTime||(g.tooltextTime=c.timeFormatterFn({type:'tooltip',dateRange:g})),!g.totalStackSumTooltip&&isValidNumber(g.totalStackSum)&&(g.totalStackSumTooltip=c.formatterFn({value:g.totalStackSum,type:'tooltip',prefix:c.prefix,suffix:c.suffix})),e=`<div style='font-size: 12px; color: #858585; margin-bottom: 2px; padding-left: 2px; font-weight:600;'>${g.tooltextTime}</div>`,g.totalStackSumTooltip&&(f=`<div style='font-size: 11px; color: #5F5F5F; margin-bottom: 2px; font-weight:600; padding-left: 2px;'>Total: ${g.totalStackSumTooltip}</div>`),e+f)}_checkPointerOverColumn(a,b,c){var d,e,f,g,h,i,j,k=this,l=k.config,m=l.plotBorderThickness,n=l.dataInfo;return(d=n[a],!d)?{pointIndex:a,hovered:!1,component:k}:(h=d.height<HTP?HTP:d.height,g=d.width<HTP?HTP:d.width,void 0===m?m=j=0:j=m/2,e=b-d.x+j,f=c-d.y+j,i=0<=e&&e<=g+m&&0<=f&&f<=h+m,{pointIndex:a,hovered:i,pointObj:d,component:k})}_firePlotEvent(a,b,c){let d,e,f=this,g=f.config.dataInfo,h=g[b]&&g[b].eventArgs||{},i=f.getFromEnv('chart'),j=getMouseCoordinate(i.getFromEnv('chart-container'),c,i),k=extend2(j,h);'fc-mouseover'===a?i.fireChartInstanceEvent(ROLLOVER,k,UNDEF,UNDEF,function(){c.FusionChartsPreventEvent=!0}):'fc-mouseout'===a?i.fireChartInstanceEvent(ROLLOUT,k):'fc-click'===a||'touchend'===a||'mouseup'===a?(i.fireChartInstanceEvent(CLICK,k),d=i.getFromEnv(),e=d&&d.linkClickFN,k.link&&e&&e.call({link:k.link},!0)):void 0}setHoverInEffect(a){this.getFromEnv('animationManager').setAnimationState('mouseOver'),this.setData(this.getHoverInConfig(a),!0)}setHoverOutEffect(a){this.getFromEnv('animationManager').setAnimationState('mouseOut'),this.setData(this.getHoverOutConfig(a),!0)}show(){this.setData({visibility:'visible'},!0)}hide(){this.setData({visibility:'hidden'},!0)}remove(){const a=this.getFromEnv('chart'),b=this.config;a.setYScaleLimit(b.scaleY.getId(),this.getId()),a.setXScaleLimit(b.scaleX.getId(),this.getId()),super.remove()}}export default Column;