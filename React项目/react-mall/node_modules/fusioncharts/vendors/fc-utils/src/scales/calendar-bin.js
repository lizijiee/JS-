import ScaleCalendar from'./calendar';import{getFloorOfDate,modifyDate,MILLISECONDS_IN_SECOND,SECONDS_IN_MINUTE,MINUTES_IN_HOUR,HOURS_IN_DAY,DAYS_IN_MONTH,DAYS_IN_YEAR}from'../scale-utils';import{pluckNumber}from'../../../fc-core/src/lib';import{getFilterdTimeFormat}from'../time-bucket';import timeConverter from'../time-converter';const DEFAULT_THRESHOLD_PIXELS=4,MAJOR='major',MINOR='minor',CONTEXT='context',DAY_1=86400000,DAY_30=2592000000,DAY_365=31536000000,MONTHS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],durationMilliSecond=1,durationSecond=MILLISECONDS_IN_SECOND*1,durationMinute=durationSecond*SECONDS_IN_MINUTE,durationHour=durationMinute*MINUTES_IN_HOUR,durationDay=durationHour*HOURS_IN_DAY,durationMonth=durationDay*DAYS_IN_MONTH,durationYear=durationDay*DAYS_IN_YEAR,domainToMajorIntervalRatio=[{ratio:4,index:8},{ratio:3,index:7},{ratio:2,index:6},{ratio:1.5,index:5},{ratio:1,index:4},{ratio:.75,index:3},{ratio:.5,index:2},{ratio:.25,index:1},{ratio:0,index:0}],clamp=(a,b,c)=>Math.min(Math.max(a,b),c),validate=a=>null!==a&&!isNaN(a),niceMinorTickIndex=a=>{let b,c=domainToMajorIntervalRatio.length,d=1/a;if(4<d)return 1/0;for(b=0;b<c;b++)if(d>domainToMajorIntervalRatio[b].ratio)return domainToMajorIntervalRatio[b].index},contextChange=(a,b,c,d)=>{let e=getFloorOfDate(new Date(a),d[c][0].name(),d[c][1]),f=getFloorOfDate(new Date(b),d[c][0].name(),d[c][1]);return+e!=+f&&[e,f]},_getStandardMinBIn=function(a,b){for(var c,d=Math.floor,e=0,f=a.length-1,g=d((f+e)/2);e<f;){if(b[2]<a[g][2])c=f=g-1;else if(b[2]>a[g][2])e=g+1;else{c=g;break}g=d((f+e)/2)}return a[c]},formatDate=a=>(10>a?'0'+a:a)+'',getFullDate=a=>`${MONTHS[a.getMonth()]} ${formatDate(a.getDate())}, ${a.getFullYear()}`,getFullTime=a=>`${formatDate(a.getHours())}:${formatDate(a.getMinutes())}:${formatDate(a.getSeconds())}`;class ScaleCalendarBin extends ScaleCalendar{constructor(a,b,c,d,e,f,g,h){super(a,b,c,d,e,f,g,h),this.thresholdIntervals=[[this.timeIntervals.millisecond,1,durationMilliSecond],[this.timeIntervals.millisecond,5,5],[this.timeIntervals.millisecond,25,25],[this.timeIntervals.millisecond,50,50],[this.timeIntervals.millisecond,250,250],[this.timeIntervals.millisecond,500,500],[this.timeIntervals.second,1,durationSecond,!0],[this.timeIntervals.second,5,5*durationSecond],[this.timeIntervals.second,15,15*durationSecond],[this.timeIntervals.second,30,30*durationSecond],[this.timeIntervals.minute,1,durationMinute,!0],[this.timeIntervals.minute,5,5*durationMinute],[this.timeIntervals.minute,15,15*durationMinute],[this.timeIntervals.minute,30,30*durationMinute],[this.timeIntervals.hour,1,durationHour,!0],[this.timeIntervals.hour,3,3*durationHour],[this.timeIntervals.hour,6,6*durationHour],[this.timeIntervals.hour,12,12*durationHour],[this.timeIntervals.day,1,durationDay,!0],[this.timeIntervals.day,3,3*durationDay],[this.timeIntervals.day,6,6*durationDay],[this.timeIntervals.day,15,15*durationDay],[this.timeIntervals.month,1,durationMonth],[this.timeIntervals.month,3,3*durationMonth],[this.timeIntervals.month,6,6*durationMonth],[this.timeIntervals.year,1,durationYear,!0]],this.binRange=[0,1],this.binDomain=[0,1],this.calculateIndexOfIntervals()}calculateIndexOfIntervals(){let a,b,c=this,d=c.thresholdIntervals,e=d.length;for(c.intervalIndexMap=a={},b=e-1;0<=b;b--)a[d[b][0].name()]=b}_computeRangeThreshold(a){var b=Math.abs;const c=this.getBinRange(),d=c[0],e=c[1],f=clamp(a,1,b(d-e)),g=+this.getDomainValue(0),h=+this.getDomainValue(f),i=b(h-g),j=this.getBinMin(),k=Math.max(0,this.thresholdIntervals.findIndex(a=>a[2]>=i));this._threshold=!j||this.thresholdIntervals[k][2]>=j[2]?this.thresholdIntervals[k]:j}getNiceMinorTickInterval(a,b){let c,d,e=this,f=e.thresholdIntervals,g=e.getDomain(),h=f[a][0].name(),j=[];for(c=a-1;0<=c;c--)if('millisecond'===h&&!(f[a][1]%f[c][1]))j.push(c);else if(f[c][0].name()!==h)break;else f[a][1]%f[c][1]||j.push(c);if(0>c)return c;if(!j.length)for(h=f[c][0].name();0<=c&&f[c][0].name()===h;c--)j.push(c);return d=Math.min(niceMinorTickIndex((g[1]-g[0])/b),j.length-1),pluckNumber(j[d],-1)}getNiceMajorTickInterval(a,b){let c,d=this,e=d.thresholdIntervals,f=e.length;if('day'===e[a][0].name()&&1<e[a][1]){for(c=a;c<f;c++)if('day'!==e[c][0].name()&&b<e[c][2])return c;}else for(c=a;c<f;c++)if(e[c][2]>b)return c;return a}generateContextTicks(a){let b,c,d,e,f=this,g=f.thresholdIntervals,h=f.intervalIndexMap,i=f.getDomain(),k=i[0],l=i[1],m=g[a][0].name(),n=g.length,o=h.day,p=h.month,q=h.year,r=-1,s=[];for(b=Math.max(a,o);b<n;b++)if(g[b][0].name()!==m){r=b;break}if(-1<r&&(e=contextChange(new Date(k),new Date(l),r,g))){for(d=e[1],e=d-g[r][2];e>=+k;)s.push(new Date(e)),e-=g[r][2];s.reverse(),s.push(new Date(d)),f._timeFormat.context=c=g[r][0].name(),r===o?(f._timeFormat[c]='%d',contextChange(new Date(k),new Date(l),p,g)&&(f._timeFormat[c]+=' %b'),contextChange(new Date(k),new Date(l),q,g)&&(f._timeFormat[c]+=' %Y')):r===p?(f._timeFormat[c]='%b',contextChange(new Date(k),new Date(l),q,g)&&(f._timeFormat[c]+=' %Y')):void 0}return s}getMajorIntervalGap(a,b){let c=this,d=c.thresholdIntervals;return'month'===d[a][0].name()?DAY_30:'year'===d[a][0].name()?DAY_365:b[1]-b[0]}ticks(a={}){let b,c,d,e,f,g,h,k,l,m,n,o,p=this,q=p.thresholdIntervals,r=p.getDomain(),s=[],t=r[0],u=r[1],v=[],w=p.getBinMin(),x=[];if(!validate(t)||!validate(u))return p._tickType=[],[];for(p._timeFormat=o={},n=u-t+1,b=d=q.length-1;0<=b;b--)if(1<Math.floor(n/q[b][2])){e=p.getNiceMajorTickInterval(b,w[2]/w[1]),f=q[e][0].name(),s=p.generateContextTicks(e)||[],t=getFloorOfDate(new Date(t),f,q[e][1]),u=modifyDate(new Date(u),f,q[e][1]),u=getFloorOfDate(new Date(u),f,q[e][1]),h=q[e][0].range(+t,+u+q[e][2],q[e][1]),o.major=f;break}if(!h)return p._tickType=[],v;for(g='month'===q[e][0].name()?p.getNiceMinorTickInterval(e,p.getMajorIntervalGap(e,h)):e-1,b=0,d=h.length;b<d-1;b++)if(v.push(h[b]),x.push(MAJOR),-1<g&&!a.minor)for(k=q[g][0].range(+h[b],+h[b+1]+1,q[g][1]),o.minor=q[g][0].name(),(c=0,l=k.length);c<l;c++)(m=+k[c],!(c===l-1&&1<l&&.5>(+h[b+1]-m)/(m-+k[c-1])))&&m!==+h[b]&&m!==+h[b+1]&&(v.push(k[c]),x.push(MINOR));if(v.push(h[d-1]),x.push(MAJOR),s.length&&!a.context)for(b=0,d=s.length;b<d;b++)v.push(s[b]),x.push(CONTEXT);return p._tickType=x,v}setBinRange(a){const b=this.getRange(),c=this.getDomain();return this.binRange=a.slice(),this.setRange(this.binRange),this.setDomain(this.binDomain),this._computeRangeThreshold(DEFAULT_THRESHOLD_PIXELS),this.setRange(b),this.setDomain(c),this}getBinRange(){return this.binRange}setBinDomain(a){const b=this.getDomain(),c=this.getRange();return this.binDomain=a.slice(),this.setRange(this.binRange),this.setDomain(this.binDomain),this._computeRangeThreshold(DEFAULT_THRESHOLD_PIXELS),this.setRange(c),this.setDomain(b),this}getBinDomain(){return this.binDomain.slice()}setBinMin(a){const b=this.getRange(),c=this.getDomain(),d=_getStandardMinBIn(this.thresholdIntervals,a);return this.minBin=d,this.setRange(this.binRange),this.setDomain(this.binDomain),this._computeRangeThreshold(DEFAULT_THRESHOLD_PIXELS),this.setRange(b),this.setDomain(c),this}getBinMin(){return this.minBin}setRangeThreshold(a=DEFAULT_THRESHOLD_PIXELS){return this._computeRangeThreshold(a),this}getRangeThreshold(){return this._threshold}setDomain(a=[]){let b;return a[0]>a[1]&&([a[1],a[0]]=[a[0],a[1]]),b=super.setDomain(a),b}nice(a,b){let c=super.nice(a,b);return this._computeRangeThreshold(DEFAULT_THRESHOLD_PIXELS),c}getFormattedTime(a={}){let b,c,d,e,f,g,h,i,j,k,l,m=this,n=m.getRangeThreshold(),o=a.dateRange,p=a.type;return'crossline'===p||'tooltip'===p?(o.endDate-=1,b=n[0].name(),c=d=getFilterdTimeFormat('%b %d, %Y %H:%M:%S:%L:%f',b),f=new Date(o.startDate),g=new Date(o.endDate),j=f.getDate()===g.getDate(),k=f.getMonth()===g.getMonth(),l=f.getFullYear()===g.getFullYear(),l&&(k?j?c.match(/%H/)?(d=d.replace(/%b/,''),d=d.replace(/%d/,''),d=d.replace(/%Y/,'')):(c=c.replace(/%b/,'%B'),d=''):c=c.replace(/%Y/,''):c=c.replace(/%Y/,'')),c=c.trim(),d=d.trim(),c=c.replace(/^,/,'').replace(/(\W+$)/,''),d=d.replace(/^,/,'').replace(/(\W+$)/,''),d&&1!==this.getRangeThreshold()[1]?(e=timeConverter.formatter(c),h=e.format(new Date(o.startDate)),e=timeConverter.formatter(d),i=e.format(new Date(o.endDate)),h+' - '+i):(e=timeConverter.formatter(c),h=e.format(new Date(o.startDate)),h)):'CRS'===p?(h=getFullDate(o.startDate)+(a.showTimeInLabel?', '+getFullTime(o.startDate):''),i=getFullDate(o.endDate)+(a.showTimeInLabel?', '+getFullTime(o.endDate):''),h+' - '+i):void 0}}export{modifyDate,getFloorOfDate};export default ScaleCalendarBin;